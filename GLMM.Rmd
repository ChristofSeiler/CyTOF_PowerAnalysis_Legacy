---
title: "Power Analysis for CyTOF Experiments"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages

```{r}
library(MCMCpack)
library(mvtnorm)
library(magrittr)
library(stringr)
library(STRINGdb)
library(ggplot2)
library(GGally)
library(lme4)
library(mbest)
library(BDgraph)
```

## Goal

Power is the probability that an estimated treatment effect is statistically significantly positive. The goal is to evaluate power as a function of the Intraclass Correlation Coefficient (ICC) through simulations.

## Prior Information on Protein-Protein Interaction

We can use the protein-protein interaction database [STRING](http://string-db.org/) to set ``Sigma``. Download proteins for human species (code is 9606). Consider interaciton that are 0.9 confidence. From the STRING website: In STRING, each protein-protein interaction is annotated with one or more 'scores'. Importantly, these scores do not indicate the strength or the specificity of the interaction. Instead, they are indicators of confidence, i.e. how likely STRING judges an interaction to be true, given the available evidence. All scores rank from 0 to 1, with 1 being the highest possible confidence. A score of 0.5 would indicate that roughly every second interaction might be erroneous (i.e., a false positive).

```{r}
markers = read.csv("markers.csv",stringsAsFactors = FALSE)
markers
p = nrow(markers)
p
```

Retrieve interactions from server.

```{r}
string_db = STRINGdb$new(version="10", species=9606, score_threshold=900, input_directory="")
markers_mapped = string_db$map(markers, "gene_nk", removeUnmappedRows = FALSE)
head(markers_mapped)
interactions = string_db$get_interactions(markers_mapped$STRING_id)
interactions = data.frame(from = interactions$from,
                          to = interactions$to,
                          combined_score = interactions$combined_score)
interactions
from_id = sapply(as.character(interactions$from),function(string_id) {
  str_detect(string_id,markers_mapped$STRING_id) %>% which
})
to_id = sapply(as.character(interactions$to),function(string_id) {
  str_detect(string_id,markers_mapped$STRING_id) %>% which
})
interactions = data.frame(interactions,from_id,to_id)
head(interactions)
adj_g = matrix(0,nrow = p,ncol = p)
for(i in 1:nrow(interactions)) {
  edge = interactions[i,]
  adj_g[edge$from_id,edge$to_id] = 1
}
colnames(adj_g) = rownames(adj_g) = markers$protein_nk
```

How does the covariance structure derived from STRING look like?

```{r}
InvSigma = rgwish(n = 1,adj.g = adj_g,b = 3)[,,1]
Sigma = chol2inv(chol(InvSigma))
X = rmvnorm(n = 10000,sigma = Sigma)
colnames(X) = markers$protein_nk
ggcorr(X)
```

## Fit Model and Calculate Power

Fix samples sizes ``n`` and explanatory variable sizes ``p``. Simulate data.

```{r}
fake_data = function(ICC) {
  # experimental design
  n_donors = 4
  n_cells = 10
  donor = rep (1:n_donors, each=n_cells)
  status = rep(c( rep(-.5,n_cells),rep(.5,n_cells)),n_donors)
  # effect size
  shift_cell = 0
  sd_donor = ICC/(1-ICC)
  sd_cell = 1
  #ICC = sd_donor/(sd_donor+sd_cell)
  #ICC
  # donor level
  explanatory_donor = NULL
  for(j in 1:n_donors) {
    explanatory_donor[j] = rnorm(n = 1,
                                 mean = 0,
                                 sd = sd_donor)
  }
  # cell level
  explanatory = response = NULL
  for(i in 1:(n_donors*n_cells)) {
    explanatory[i] = rnorm(n = 1,
                           mean = status[i]*shift_cell + explanatory_donor[donor[i]],
                           sd = sd_cell)
  }
  data.frame(status = factor(status,labels = c("LTNP","CP")),
             explanatory,
             donor = factor(donor))
}
test = fake_data(0.5)
ggplot(test, aes(status,explanatory,color = donor)) + 
  geom_point(position=position_jitter(w=0.3,h=0), size=4)
```

Power analysis for Generalized Linear Models (GLMs) without random effects.

```{r}
alpha = 0.05
n_sim = 100
ICCs = seq(0.1,0.9,0.1)
power_glm = function(ICC) {
  power = sapply(1:n_sim,function(i) {
    cat(".")
    test = fake_data(ICC)
    formula = as.formula(status ~ explanatory)
    res_glm = glm(formula,family = binomial(link='logit'), data = test)
    pvalues = summary(res_glm)$coefficients[-1,4]
    mean(p.adjust(pvalues,method = "BH") < alpha)
    })
  mean(power)
}
power = sapply(ICCs,power_glm)
ggplot(data.frame(ICCs,power),aes(ICCs,power)) + 
  geom_line() + geom_point() + 
  labs(title = paste0("alpha = ",alpha)) + 
  geom_hline(yintercept = alpha,color = "red")
```

Power analysis for Generalized Linear Mixed Models (GLMM) with random effects.

```{r}
power_glmm = function(ICC) {
  power = sapply(1:n_sim,function(i) {
    cat(".")
    test = fake_data(ICC)
    res_glm = mhglm(status ~ explanatory + (explanatory | donor),
                    family = binomial(link='logit'),
                    data = test,
                    control = mhglm.control(parallel = TRUE,fit.method = 'firthglm.fit'))
    pvalues = summary(res_glm)$coefficients[-1,4]
    mean(p.adjust(pvalues,method = "BH") < alpha)
  })
  mean(power)
}
power = sapply(ICCs,power_glmm)
ggplot(data.frame(ICCs,power),aes(ICCs,power)) + 
  geom_line() + geom_point() + 
  labs(title = paste0("alpha = ",alpha)) +
  geom_hline(yintercept = alpha,color = "red")
```

## Session Info

```{r}
sessionInfo()
```
