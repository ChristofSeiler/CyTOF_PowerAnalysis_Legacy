---
title: "Power Analysis for CyTOF Experiments"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages

```{r}
library(MCMCpack)
library(mvtnorm)
library(magrittr)
library(stringr)
library(STRINGdb)
library(ggplot2)
library(GGally)
library(lme4)
library(mbest)
```

## Goal

Power is the probability that an estimated treatment effect is statistically significantly positive. The goal is to evaluate power as a function of the number of donors using simulated fake-data. Based on our assumptions, we setup a model, generate fake data, and set paramters. The paramters are taken from the Angelo et al. 2015[^1].

## Generate Fake Data

We can use the protein-protein interaction database [STRING](http://string-db.org/) to set ``Sigma``. Download proteins for human species (code is 9606). Consider interaciton that are 0.9 confidence. From the STRING website: In STRING, each protein-protein interaction is annotated with one or more 'scores'. Importantly, these scores do not indicate the strength or the specificity of the interaction. Instead, they are indicators of confidence, i.e. how likely STRING judges an interaction to be true, given the available evidence. All scores rank from 0 to 1, with 1 being the highest possible confidence. A score of 0.5 would indicate that roughly every second interaction might be erroneous (i.e., a false positive).

```{r}
markers = read.csv("markers.csv",stringsAsFactors = FALSE)
head(markers)
p = nrow(markers)
p
```

Retrieve interactions from server.

```{r}
markers_mapped = string_db$map(markers, "gene_nk", removeUnmappedRows = FALSE)
head(markers_mapped)
interactions = string_db$get_interactions(markers_mapped$STRING_id)
interactions = data.frame(from = interactions$from,
                          to = interactions$to,
                          combined_score = interactions$combined_score)
interactions
from_id = sapply(as.character(interactions$from),function(string_id) {
  str_detect(string_id,markers_mapped$STRING_id) %>% which
})
to_id = sapply(as.character(interactions$to),function(string_id) {
  str_detect(string_id,markers_mapped$STRING_id) %>% which
})
interactions = data.frame(interactions,from_id,to_id)
head(interactions)
adj_g = matrix(0,nrow = p,ncol = p)
for(i in 1:nrow(interactions)) {
  edge = interactions[i,]
  adj_g[edge$from_id,edge$to_id] = 1
}
colnames(adj_g) = markers$protein_nk
ggcorr(adj_g)
```

Draw coefficents for each donor.

```{r}
draw_X = function() {
  precision = rgwish(n = 1,adj.g = adj_g,b = 3)[,,1]
  X = rmvnorm(n = n_cell,sigma = chol2inv(chol(precision)))
  colnames(X) = markers$protein_nk
  X
}
X = draw_X()
ggcorr(X)
```

Draw random vector.

```{r}
Sigma0 = diag(p)
Sigma = riwish(v = v,S = Sigma0)
y = rmvt(n = 1,sigma = Sigma,df = v) %>% t
```

## Fit Model and Calculate Power

Fix samples sizes ``n`` and explanatory variable sizes ``p``. Simulate data.

```{r}
#inv_logit = function(u) {
#  return(1 / (1 + exp(-u)));
#}
fake_data = function() {
  # experimental design
  n_donors = 1
  n_cells = 100
  donor = rep (1:n_donors, each=n_cells)
  treatment = rep(c( rep(-.5,n_cells/2),rep(.5,n_cells/2)),n_donors)
  # effect size
  shift_donor = rep(0,n_donors)
  shift_donor[1] = 0
  shift_cell = 0
  # donor level
  explanatory_donor = NULL
  for(j in 1:n_donors) {
    explanatory_donor[j] = rnorm(n = 1,
                                 mean = 0,
                                 sd = 1)
  }
  # cell level
  explanatory = response = NULL
  for(i in 1:(n_donors*n_cells)) {
    explanatory[i] = rnorm(n = 1,
                           mean = treatment[i]*(shift_cell + explanatory_donor[donor[i]]*shift_donor[donor[i]]),
                           sd = 1)
    #response[i] = rbinom(n = 1,
    #                     size = 1, 
    #                     prob = inv_logit(explanatory[i]))
    u = rlogis(n = 1,location = explanatory[i],scale = 1)
    if(u > 0) response[i] = 1
    if(u < 0) response[i] = 0
  }
  data.frame(response = factor(response,labels = c("LTNP","CP")),
             treatment = factor(treatment,labels = c("LTNP","CP")),
             explanatory,
             donor = factor(donor))
}
test = fake_data()
ggplot(test, aes(treatment,explanatory,color = donor)) + 
  geom_point(position=position_jitter(w=0.3,h=0), size=4)
```

Power analysis.

```{r}
n_sim = 1000
power = sapply(1:n_sim,function(i) {
  alpha = 0.05
  fake = fake_data()
  formula = as.formula(treatment ~ explanatory)
  res_glm = glm(formula,family = binomial(link='logit'), data = fake)
  #res_glm = mhglm(y ~ marker + (marker | donor),
  #                  family = binomial(link='logit'),
  #                  data = fake,
  #                  control = mhglm.control(parallel = TRUE,fit.method = 'firthglm.fit'))
  pvalues = summary(res_glm)$coefficients[-1,4]
  mean(p.adjust(pvalues,method = "BH") < alpha)
  # test
  #groupCP = subset(fake,treatment == "CP")["explanatory"]
  #groupLTNP = subset(fake,treatment == "LTNP")["explanatory"]
  #t.test(groupCP,groupLTNP)$p.value < alpha
})
mean(power)
```

## Session Info

```{r}
sessionInfo()
```

[^1]: Angelo et al. 2015. Practical NK cell phenotyping and variability in healthy adults.
